const ErrorFunction = function (jqXHR, textStatus, err)
{
    OnError(jqXHR, textStatus, err);

    if (jqXHR.status == 500)
    {
        MessageCenter('An error occurred while processing your request. Please try again.', 'error');
        jqXHR.abort();
    }
    return false;
}

$('#lnkCMSBranchSearch').click(function ()
{
    Agency_CMS_Exc_Get_State();


});

$('#ddlState').change(function ()
{
    Agency_Get_Exc_mapped_CMSBank_Lnk();
});

//$('#ddlEXCCMSBranch').change(function ()
//{
//    $('#hdnEXCCMSbankCode').val($('#ddlEXCCMSBranch').val()).change();
//    $('#txtEXCCMSbankName').val($('#ddlEXCCMSBranch :Selected').text());
//    $('#ModelCMSBranchClose').click();
//    $('#ddlState').val('select');
//    $('#ddlEXCCMSBranch').val('select');
//    $('#modellblErrormsg').text('');
//});

function Agency_CMS_Exc_Get_State()
{
    $('#modellblErrormsg').text('');
    ExtendedAjaxCall('CMS/Agency_CMS_Exc_Get_State', null, 'GET', function (result)
    {

        var html = '<option value="select">Select</option>'
        if (!$.isEmptyObject(result))
        {
            $.each(result, function (i, row)
            {
                html += "<option value='" + row['Code'] + "' >" + row['Desc'] + "</option>";
            });
        }

        $('#ddlState').html(html).change();
    }, null, null, false, false, ErrorFunction);
}

function Agency_Get_Exc_mapped_CMSBank_Lnk()
{
    $('#modellblErrormsg').text('');
    ExtendedAjaxCall('CMS/Agency_Get_Exc_mapped_CMSBank_Lnk/' + $('#ddlState').val(), null, 'GET', function (result)
    {
        //var html = '<option value="select">Select</option>'
        //if (!$.isEmptyObject(result))
        //{
        //    $.each(result, function (i, row)
        //    {
        //        html += "<option value='" + row['code'] + "' >" + row['desc'] + "</option>";
        //    });
        //}
        //$('#ddlEXCCMSBranch').html(html);

        var html = ''
        if (!$.isEmptyObject(result))
        {
            $.each(result, function (i, row)
            {
                html += '<tr>';
                html += '<td ><input type="radio" id="rdoCMS" onclick="rdoCMS_select(this)" name="CMS" value="' + row['code'] + '"  /> </td>';
                html += '<td >' + row['desc'] + '</td>';
                html += '<td >' + row['Address'] + '</td>';
                html += '</tr>';
            });
        }
        $('#tblCMSBranch tbody').html(html);
    }, null, null, false, false, ErrorFunction);
}

function rdoCMS_select(btn)
{

    var code = $(btn).val();
    var name = $($(btn).closest('tr').find('td')[1]).text();
    if ($("#ddlCMSBranch option[value='" + code + "']").length != 0)
    {
        // it exists!
        $('#ddlCMSBranch').val(code).change();
    }
    else
    {
        var html = '<option value="' + code + '">' + name + '</option>';
        $('#ddlCMSBranch').append(html).val(code).change();
    }
    //$('#ModelCMSBranchClose').click();
    $('#ModelCMSBranchSearch').modal('hide');
    $('#ddlState').val('select').change();
    $('#ddlEXCCMSBranch').val('select');
    $('#modellblErrormsg').text('');
};
$('#lnkCMSBranchSearchGen').click(function ()
{
    Agency_CMS_Exc_Get_State_Gen();


});

$('#ddlStateGen').change(function ()
{
    Agency_Get_Exc_mapped_CMSBank_Lnk_Gen();
});

//$('#ddlEXCCMSBranch').change(function ()
//{
//    $('#hdnEXCCMSbankCode').val($('#ddlEXCCMSBranch').val()).change();
//    $('#txtEXCCMSbankName').val($('#ddlEXCCMSBranch :Selected').text());
//    $('#ModelCMSBranchClose').click();
//    $('#ddlState').val('select');
//    $('#ddlEXCCMSBranch').val('select');
//    $('#modellblErrormsg').text('');
//});

function Agency_CMS_Exc_Get_State_Gen()
{
    $('#modellblErrormsg_Gen').text('');
    ExtendedAjaxCall('CMS/Agency_CMS_Exc_Get_State', null, 'GET', function (result)
    {

        var html = '<option value="select">Select</option>'
        if (!$.isEmptyObject(result))
        {
            $.each(result, function (i, row)
            {
                html += "<option value='" + row['Code'] + "' >" + row['Desc'] + "</option>";
            });
        }

        $('#ddlStateGen').html(html).change();
    }, null, null, false, false, ErrorFunction);
}

function Agency_Get_Exc_mapped_CMSBank_Lnk_Gen()
{
    $('#modellblErrormsg_Gen').text('');
    ExtendedAjaxCall('CMS/Agency_Get_Exc_mapped_CMSBank_Lnk/' + $('#ddlStateGen').val(), null, 'GET', function (result)
    {
        //var html = '<option value="select">Select</option>'
        //if (!$.isEmptyObject(result))
        //{
        //    $.each(result, function (i, row)
        //    {
        //        html += "<option value='" + row['code'] + "' >" + row['desc'] + "</option>";
        //    });
        //}
        //$('#ddlEXCCMSBranch').html(html);

        var html = ''
        if (!$.isEmptyObject(result))
        {
            $.each(result, function (i, row)
            {
                html += '<tr>';
                html += '<td ><input type="radio" id="rdoCMS" onclick="rdoCMS_select_Gen(this)" name="CMS" value="' + row['code'] + '"  /> </td>';
                html += '<td >' + row['desc'] + '</td>';
                html += '<td >' + row['Address'] + '</td>';
                html += '</tr>';
            });
        }
        $('#tblCMSBranchGen tbody').html(html);
    }, null, null, false, false, ErrorFunction);
}

function rdoCMS_select_Gen(btn)
{

    var code = $(btn).val();
    var name = $($(btn).closest('tr').find('td')[1]).text();
    if ($("#ddlCMSBranchGen option[value='" + code + "']").length != 0)
    {
        // it exists!
        $('#ddlCMSBranchGen').val(code).change();
    }
    else
    {
        var html = '<option value="' + code + '">' + name + '</option>';
        $('#ddlCMSBranchGen').append(html).val(code).change();
    }
    //$('#ModelCMSBranchClose').click();
    $('#ModelCMSBranchSearchGen').modal('hide');
    $('#ddlStateGen').val('select').change();
    $('#ddlEXCCMSBranchGen').val('select');
    $('#modellblErrormsg_Gen').text('');
};
var EXC_CMS_MAPPING_FLAG = 0;

$(document).ready(function ()
{
    $('.alert').show();

    $('#DV_MSG_CENTER').show();
    CancelClickEntry();
    MainBtnHandler(false, false, false, false, false, true, false);
    //$("#btnSave").off().on("click", SaveClickEntry);
    //$("#btnCancel").off().on("click", CancelClickEntry);
    $('#payinslipcount').val('0');
    $('#payinslipTotalcount').text('0');
    //$("#btnSearch").off().on("click", SearchClick);
    // $('#chkAddSelectAll').val('0')
    $('#tblStaging #chkAddSelectAll').prop('checked', false);
    getBank();
    getBranch();

    ExtendedAjaxCall('CMS/GET_EXC_CMS_MAPPING_FLAG', null, 'GET', function (result)
    {
        if (!$.isEmptyObject(result))
        {
            EXC_CMS_MAPPING_FLAG = result[0].status;

        } else
        {
            MessageCenter('Something went weong.', 'error');
        }
    }, null, null, false, false, ErrorFunction);


    if (EXC_CMS_MAPPING_FLAG == 1)
    {
        $('#lnkCMSBranchSearch').show();

    }
    else
    {
        $('#lnkCMSBranchSearch').hide();
    }

});

function BindPayinDataDtlforsave()
{

    $('#payinslipcount').text('0');
    $('#payinslipTotalcount').text('0');

    if ($('#ddlBranchName').val() == "0")
    {
        MessageCenter('Please select CPTP Location', 'error');
        return;
    }
    var BankName = $('#ddlBankName').val();

    var BranchCode = $('#ddlStateName').val();

    var BTPLocationCode = $('#ddlBranchName').val();
    var BTP_LocationDesc = $('#ddlBranchName option:selected').text();
    $('#tblStaging').DataTable().destroy();
    $('#tblStaging > tbody').html('');
    //var table = $('#tblStaging').DataTable();
    //table.destroy();
    var htmlstr = '';
    //$('#tblStaging').DataTable().destroy();
    ExtendedAjaxCall('PayinSlip/GetStagingData?CMSBankName=' + BankName + '&MFBranchCode=' + BranchCode + '&BTP_Agency_Branch_Code=' + BTPLocationCode + ' &BTP_Agency_BranchName=' + BTP_LocationDesc + '', null, 'GET', function (result)
    {

        if (result !== null && typeof (result) !== 'undefined')
        {
            if (result.length > 0)
            {
                $.each(result, function (i, row)
                {

                    //htmlstr += '<tr>';
                    htmlstr += '<tr>';
                    if (row["Status"])
                    {
                        htmlstr += "<td class='text-center'><input type='checkbox' class='Checkbox' data-row ='" + JSON.stringify(row) + "' onchange='chechCount(this)'  /></td>";
                    }
                    else
                    {
                        htmlstr += '<td></td>';
                    }
                    //htmlstr += '<td style=display:none>' + row["Payinslip_Stg_HdrSequence"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Payinslip_SourceName"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["PortalSourceCode"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["MCP_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Scp_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["MCP_Broker_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Scp_Broker_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["CP_Trans_Ref_No"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Employee_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Ref_Other_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Ref_Type"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Ref_Cust_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Ref_RM_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Cheque_Number"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Cheque_Date"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Cheque_Amt"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Drawn_Bank_Name"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Drawn_Branch_Name"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["SCP_Location_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["SCP_Location_Name"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["f_Entry_Date"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Pick_Up_Date"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Pick_Date"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Remarks"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Queue_State"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Queue_Status"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Queue_Remarks"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["DrawnBankIFSCCode"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["DrawnBankMICRCode"] + '</td>';
                    htmlstr += '<td>' + row["ApplicationDeclarationType"] + '</td>';
                    htmlstr += '<td>' + row["Applicant_Name"] + '</td>';
                    htmlstr += '<td>' + row["Application_Number"] + '</td>';
                    htmlstr += '<td>' + row["Entry_Date"] + '</td>';
                    htmlstr += '<td align="right" >' + row["Cheque_Number"] + '</td>';
                    htmlstr += '<td>' + row["Cheque_Date"] + '</td>';
                    htmlstr += '<td align="right">' + row["Cheque_Amt"] + '</td>';
                    htmlstr += '<td>' + row["Drawn_Bank_Name"] + '</td>';
                    htmlstr += '<td>' + row["Drawn_Branch_Name"] + '</td>';
                    htmlstr += '<td>' + row["DrawnBankIFSCCode"] + '</td>';
                    htmlstr += '<td>' + row["DrawnBankMICRCode"] + '</td>';
                    htmlstr += '<td>' + row["Remark"] + '</td>';

                    htmlstr += '</tr>';

                });




                $('#tblStaging> tbody').html(htmlstr);


                //table = $('#tblStaging').DataTable({
                //    "order": [[2, "asc"]],
                //    initComplete: function () {
                //        $("#preloader").hide();
                //    }
                //});
                $('#divGetDetails').show();
                $('#payinslipTotalcount').text(result.length);
                $('#tblStaging').DataTable({
                    destroy: true,
                    initComplete: function ()
                    {
                        $("#preloader").hide();
                    }
                });



                //Bind DatePicker
                //MainBtnHandler(false, false, true, false, false, true, false);
                // $('#btnSave').bind('click', SaveClickEntry);
                //$("#btnSaveEntry").off().on("click", SaveClickEntry);
                //$('#btnCancelEntry').bind('click', CancelClickEntry);

            } else
            {
                // MessageCenter("Data not found", 'error');
                // $('#pnlSearchData').hide();
            }
        } else
        {
            //  $('#lblLookUpMessage').text('something went wrong while binding Request').addClass('red-text');
            // MessageCenter("Data not found", 'error');
        }

    }, null, null, false, true);
}

$('#btnSaveEntry').click(function ()
{
    SaveClickEntry();
});

function SaveClickEntry()
{
    if ($('#tblStaging > tbody input[type=checkbox]').length > 0)
    {
        if ($('#tblStaging  > tbody input[type=checkbox]:checked').prop('checked') == true)
        {

            var obj1 = [];
            $('#tblStaging  > tbody input[type=checkbox]:checked').each(function (key, element)
            {
                //select row
                var row = $(element).data('row');

                var PayinslipStaging = {
                    Payinslip_Stg_HdrSequence: row["Payinslip_Stg_HdrSequence"],
                    Payinslip_Source_Name: row["Payinslip_SourceName"],
                    PortalSourceCode: row["PortalSourceCode"],
                    MCP_Code: row["MCP_Code"],
                    SCP_Code: row["Scp_Code"],
                    MCP_Broker_Code: row["MCP_Broker_Code"],
                    SCP_Broker_Code: row["Scp_Broker_Code"],
                    Employee_Code: row["Employee_Code"],
                    ADO_Indicator: "",
                    CMS_Type: row["CMS_Type"],
                    CP_Trans_Ref_No: row["CP_Trans_Ref_No"],
                    MF_Sys_Ref_No: "",
                    Ref_Type: row["Ref_Type"],
                    Ref_Cust_Code: row["Ref_Cust_Code"],
                    Ref_RM_Code: row["Ref_RM_Code"],
                    Ref_Other_Code: row["Ref_Other_Code"],
                    Cheque_Number: row["Cheque_Number"],
                    Process_Remarks: "",
                    CMS_Bank_Name: row["CMS_Bank_Name"],
                    CMS_Branch_Name: row["CMS_Branc_Name"],
                    CMS_IFSC_Code: row["CMS_Bank_IFSC_Code"],
                    CMS_MICR_Code: row["CMS_Bank_MICR_Code"],
                    Drawn_Bank_Name: row["Drawn_Bank_Name"],
                    Drawn_Branch_name: row["Drawn_Branch_Name"],
                    Applicant_Name: row["Applicant_Name"],
                    Application_No: row["Application_Number"],
                    MF_Branch_Name: row["MF_Branch_Name"],
                    MF_Branch_Code: row["MF_Branch_Code"],
                    SCP_Location_Code: row["SCP_Location_Code"],
                    SCP_Location_Name: row["SCP_Location_Name"],
                    Entry_Date: row["f_Entry_Date"],
                    Cheque_Date: row["Cheque_Date"],
                    Cheque_Amount: row["Cheque_Amt"],
                    Payinslip_No: "",
                    Remarks: row["Remarks"],
                    Pickup_Date: row["Pick_Up_Date"],
                    Req_Remarks: row["Queue_Remarks"],
                    Req_State: row["Queue_State"],
                    Req_Status: row["Queue_Status"],
                    CMS_LOC_CODE: row["CMS_Location_Code"],
                    CMS_LOC_NAME: row["CMS_Location_Name"],
                    Drawn_Bank_IFSC: row["DrawnBankIFSCCode"],
                    Drawn_Bank_MICR: row["DrawnBankMICRCode"],
                    BTP_LOC_CODE: $('#ddlBranchName').val(),
                    BTP_LOC_DESC: $('#ddlBranchName option:selected').text(),
                    count: $('#payinslipcount').text()
                };
                //Push to list
                obj1.push(PayinslipStaging);
            });

            var payinSlip = {

                payinslipBos: obj1,

            };
            ExtendedAjaxCall('PayinSlip/Save', payinSlip, 'POST', function (result)
            {


                if (result.isResponce)
                {
                    MessageCenter(result.result, "success");

                    $('#divGetDetails').hide();
                    $('#tblStaging > tbody').html('');
                    $('#payinslipcount').text('0');
                    $('#payinslipTotalcount').text('0');
                    $('#tblStaging #chkAddSelectAll').prop('checked', false);
                    // BindPayinDataDtl()
                    BindPayinDataDtlforsave();
                } else
                {
                    MessageCenter(result.result, "error");
                }

            }, null, null, false, true);

           // $('#btnCancelEntry').bind('click', CancelClickEntry);
        } else
        {
            MessageCenter("Please select atlest one request", "error");
            return false;
        }
    }
    else
    {
        MessageCenter("No Record Found for Save", "error");
        return false;

    }
}

var selectedDataCount = 0;

function SetSelectedRowCount()
{
    if ($('#tblStaging #chkAddSelectAll').prop("checked"))
    {
        selectedDataCount = parseInt(selectedDataCount) + 1;
    }
    else if (!$('#tblStaging #chkAddSelectAll').prop("checked"))
    {
        selectedDataCount = parseInt(selectedDataCount) - 1;
    }
}

$('#btnSaveEntry').click(function ()
{
    CancelClickEntry();
});

function CancelClickEntry()
{
    $('#divGetDetails').hide();
    $('#tblStaging > tbody').html('');
    $('#payinslipcount').text('0');
    $('#payinslipTotalcount').text('0');
    $('#ddlBranchName').val('0');
    $('#ddlBankName').val('0');
    $('#ddlStateName').empty().append('<option value="0">Select</option>');
    MessageCenter("", '');
    $('#ddlBankName,#ddlBranchName').val('0');
    //$('#hdnEXCCMSbankCode,#txtEXCCMSbankName').val('');
    MainBtnHandler(false, false, false, false, false, true, false);
    $('#tblStaging #chkAddSelectAll').prop('checked', false);
}


$('#ddlBranchName').on('change', function ()
{
    MessageCenter('', '');
    if ($('#ddlBranchName').val() == "0")
    {
        MessageCenter('Please select Branch', 'error');
        return;
    }
    var StateCode = $('#ddlBranchName').val();

    $('#ddlStateName').empty();
    ClearFormEntry();
    $('#tblAlllocations > tbody').html('');
    var htmlstr = '';
    ExtendedAjaxCall('PayinSlip/GetCMSBranch?locCode=' + StateCode + '', null, 'GET', function (result)
    {

        if (result !== null && typeof (result) !== 'undefined')
        {
            if (result.length > 0)
            {
                $('#ddlStateName').empty();
                $('#ddlStateName').append("<option value='0' data-row='0'>Select</option>");
                $.each(result, function (i, row)
                {
                    $('#ddlStateName').append("<option value='" + row['Agency_CMS_Branch_Code'] + "' data-row='" + JSON.stringify(row) + "'>" + row['Agency_CMC_Branch_Name'] + "</option>");
                });

            } else
            {
                $('#lblLookUpMessage').text('No Request found').addClass('red-text');
            }
        } else
        {
            $('#lblLookUpMessage').text('something went wrong while binding Request').addClass('red-text');
        }
    }, null, null, false, false, ErrorFunction);

});

$('#ddlStateName').on('change', function ()
{
    MessageCenter('', '');
    $('#payinslipcount').text('0');
    $('#payinslipTotalcount').text('0');

    if ($('#ddlBranchName').val() == "0")
    {
        MessageCenter('Please select CPTP Location', 'error');
        return;
    }
    var BankName = $('#ddlBankName').val();
    var BranchCode = $('#ddlStateName option:selected').val();
    var BTPLocationCode = $('#ddlBranchName').val();
    var BTP_LocationDesc = $('#ddlBranchName option:selected').text();
    $('#tblStaging').DataTable().destroy();
    $('#tblStaging > tbody').html('');
    //var table = $('#tblStaging').DataTable();
    //table.destroy();
    var htmlstr = '';
    //$('#tblStaging').DataTable().destroy();
    ExtendedAjaxCall('PayinSlip/GetStagingData?CMSBankName=' + BankName + '&MFBranchCode=' + BranchCode + '&BTP_Agency_Branch_Code=' + BTPLocationCode + ' &BTP_Agency_BranchName=' + BTP_LocationDesc + '', null, 'GET', function (result)
    {


        if (result !== null && typeof (result) !== 'undefined')
        {
            if (result.length > 0)
            {
                $.each(result, function (i, row)
                {

                    //htmlstr += '<tr>';
                    htmlstr += '<tr>';
                    if (row["Status"])
                    {
                        htmlstr += "<td class='text-center'><input type='checkbox' class='Checkbox' data-row ='" + JSON.stringify(row) + "' onchange='chechCount(this)'  /></td>";
                    }
                    else
                    {
                        htmlstr += '<td></td>';
                    }
                    //htmlstr += '<td style=display:none>' + row["Payinslip_Stg_HdrSequence"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Payinslip_SourceName"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["PortalSourceCode"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["MCP_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Scp_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["MCP_Broker_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Scp_Broker_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["CP_Trans_Ref_No"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Employee_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Ref_Other_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Ref_Type"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Ref_Cust_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Ref_RM_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Cheque_Number"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Cheque_Date"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Cheque_Amt"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Drawn_Bank_Name"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Drawn_Branch_Name"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["SCP_Location_Code"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["SCP_Location_Name"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["f_Entry_Date"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Pick_Up_Date"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Pick_Date"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Remarks"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Queue_State"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Queue_Status"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["Queue_Remarks"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["DrawnBankIFSCCode"] + '</td>';
                    //htmlstr += '<td style=display:none>' + row["DrawnBankMICRCode"] + '</td>';
                    htmlstr += '<td>' + row["ApplicationDeclarationType"] + '</td>';
                    htmlstr += '<td>' + row["Applicant_Name"] + '</td>';
                    htmlstr += '<td>' + row["Application_Number"] + '</td>';
                    htmlstr += '<td>' + row["Entry_Date"] + '</td>';
                    htmlstr += '<td align="right" >' + row["Cheque_Number"] + '</td>';
                    htmlstr += '<td>' + row["Cheque_Date"] + '</td>';
                    htmlstr += '<td align="right">' + row["Cheque_Amt"] + '</td>';
                    htmlstr += '<td>' + row["Drawn_Bank_Name"] + '</td>';
                    htmlstr += '<td>' + row["Drawn_Branch_Name"] + '</td>';
                    htmlstr += '<td>' + row["DrawnBankIFSCCode"] + '</td>';
                    htmlstr += '<td>' + row["DrawnBankMICRCode"] + '</td>';
                    htmlstr += '<td>' + row["Remark"] + '</td>';

                    htmlstr += '</tr>';

                });




                $('#tblStaging> tbody').html(htmlstr);


                //table = $('#tblStaging').DataTable({
                //    "order": [[2, "asc"]],
                //    initComplete: function () {
                //        $("#preloader").hide();
                //    }
                //});
                $('#divGetDetails').show();
                $('#payinslipTotalcount').text(result.length);
                $('#tblStaging').DataTable({
                    destroy: true,
                    initComplete: function ()
                    {
                        $("#preloader").hide();
                    }
                });



                //Bind DatePicker
                //MainBtnHandler(false, false, true, false, false, true, false);
                //$('#btnSave').bind('click', SaveClickEntry);
                //$('#btnCancel').bind('click', CancelClickEntry);

            } else
            {
                MessageCenter("Data not found", 'error');
                // $('#pnlSearchData').hide();
            }
        } else
        {
            //  $('#lblLookUpMessage').text('something went wrong while binding Request').addClass('red-text');
            MessageCenter("Data not found", 'error');
        }

    }, null, null, false, false, ErrorFunction);

});


function chechCount(btn)
{
    var count = 0;
    $('#tblStaging .Checkbox').each(function ()
    {
        if ($(this).prop('checked'))
        {
            count += 1;
        }
    });
    $('#payinslipcount').text(count);

}

$('#tblStaging #chkAddSelectAll').on('change', function ()
{
    var count = 0;
    if ($('#tblStaging #chkAddSelectAll').prop('checked'))
    {
        $('#tblStaging .Checkbox').each(function (key, element)
        {
            $(element).prop('checked', true);
            count += 1;
        });
    } else
    {
        $('#tblStaging .Checkbox').each(function (key, element)
        {
            $(element).prop('checked', false);
        });
    }

    $('#payinslipcount').text(count);
});

function getBank()
{

    ExtendedAjaxCall('PayinSlip/GetBank', null, 'GET', function (result)
    {

        if (result !== null && typeof (result) !== 'undefined')
        {
            if (result.length > 0)
            {
                $('#ddlBankName').empty();
                $('#ddlBankName').append("<option value='0' data-row='0'>Select</option>");
                $.each(result, function (i, row)
                {

                    $('#ddlBankName').append("<option value='" + row['Cms_Bank_Code'] + "' data-row='" + JSON.stringify(row) + "'>" + row['Cms_Bank_Name'] + "</option>");
                });

            } else
            {
                $('#lblLookUpMessage').text('No Request found').addClass('red-text');
            }
        } else
        {
            $('#lblLookUpMessage').text('something went wrong while binding Request').addClass('red-text');
        }
    }, null, null, false, false, ErrorFunction);
}

function getBranch()
{

    ExtendedAjaxCall('PayinSlip/GetBranch', null, 'GET', function (result)
    {

        if (result !== null && typeof (result) !== 'undefined')
        {
            if (result.length > 0)
            {
                $('#ddlBranchName').empty();
                $('#ddlBranchName').append("<option value='0' data-row='0'>Select</option>");
                $.each(result, function (i, row)
                {

                    $('#ddlBranchName').append("<option value='" + row['Agency_Loc_Cd'] + "' data-row='" + JSON.stringify(row) + "'>" + row['Agency_Loc_Desc'] + "</option>");
                });

            } else
            {
                $('#lblLookUpMessage').text('No Request found').addClass('red-text');
            }
        } else
        {
            $('#lblLookUpMessage').text('something went wrong while binding Request').addClass('red-text');
        }
    }, null, null, false, false, ErrorFunction);
}

function ClearFormEntry()
{

    $('#ddlStateName').empty();
    $('#tblStaging > tbody').html('');
    $('#payinslipcount').text('0');
    $('#payinslipTotalcount').text('0');
}

function rdoCMS_select(btn)
{

    var code = $(btn).val();
    var name = $($(btn).closest('tr').find('td')[1]).text();
    if ($("#ddlStateName option[value='" + code + "']").length != 0)
    {
        // it exists!
        $('#ddlStateName').val(code).change();
    }
    else
    {
        var html = '<option value="' + code + '">' + name + '</option>';
        $('#ddlStateName').append(html).val(code).change();
    }
    $('#ModelCMSBranchClose').click();
    $('#ddlState').val('select').change();
    $('#ddlEXCCMSBranch').val('select');
    $('#modellblErrormsg').text('');
};



var EXC_CMS_MAPPING_FLAG = 0;

$(document).ready(function ()
{
    $('#DV_MSG_CENTER').show();

    CancelClickGen();
    //MainBtnHandler(false, false, false, false, true, true, false);

    //$("#btnCancelGen").off().on("click", CancelClickGen);

    //$("#btnSearchGen").off().on("click", SearchClick);
    getBankGen();
    getBranchGen();
    $('#txtStartDateGen, #txtEndDateGen').datepicker({ autoclose: true, format: 'dd/mm/yyyy' });

    ExtendedAjaxCall('CMS/GET_EXC_CMS_MAPPING_FLAG', null, 'GET', function (result)
    {
        if (!$.isEmptyObject(result))
        {
            EXC_CMS_MAPPING_FLAG = result[0].status;

        } else
        {
            MessageCenter('Something went wrong.', 'error');
        }
    }, null, null, false, false, ErrorFunction);

    //if (EXC_CMS_MAPPING_FLAG == 1)
    //{
    //    $('#PnlddlCMSbank').hide();
    //    $('#PnlddlEXCCMSbank').show();
    //}
    //else
    //{
    //    $('#PnlddlCMSbank').show();
    //    $('#PnlddlEXCCMSbank').hide();
    //}

    if (EXC_CMS_MAPPING_FLAG == 1)
    {
        $('#lnkCMSBranchSearchGen').show();

    }
    else
    {
        $('#lnkCMSBranchSearchGen').hide();
    }
});

$('#btnCancelGen').click(function ()
{
    CancelClickGen();
});

function CancelClickGen()
{
    $('#divGetDetailsGen').hide();
    $('#tblStagingGen > tbody').html('');
    MessageCenter("", '');
    $('#ddlStateNameGen').empty().append('<option value="0">Select</option>');
    $('#txtEndDateGen').val('');
    $('#txtStartDateGen').val('');
    $('#ddlBankNameGen,#ddlBranchNameGen').val('0');
    //$('#hdnEXCCMSbankCode,#txtEXCCMSbankName').val('');
    //MainBtnHandler(false, false, false, false, true, true, false);
    //$("#btnSearchGen").off().on("click", SearchClick);
}

$('#btnSearchGen').click(function ()
{
    SearchClick();
});

function SearchClick()
{
    MessageCenter('', '');

    if ($('#ddlBankNameGen').val() == "0")
    {
        MessageCenter('Please select CMS Bank', 'error');
        return false;
    }

    if ($('#ddlBranchNameGen').val() == "0")
    {
        MessageCenter('Please select BTP Location', 'error');
        return false;
    }

    //if (EXC_CMS_MAPPING_FLAG == 1 && $('#hdnEXCCMSbankCode').val() == "")
    //{
    //    MessageCenter('Please select CMS Branch.', 'error');
    //    return false;
    //}
    //else if (EXC_CMS_MAPPING_FLAG == 0 && $('#ddlStateName').val() == "0" || $('#ddlStateName').val() == "")
    //{
    //    MessageCenter('Please select CMS Branch.', 'error');
    //    return false;
    //}

    if ($('#ddlStateNameGen').val() == "0" || $('#ddlStateName').val() == "")
    {
        MessageCenter('Please select CMS Branch.', 'error');
        return false;
    }


    if ($('#txtStartDateGen').val() == "")
    {
        MessageCenter('Please enter from date', 'error');
        return false;
    }

    if ($('#txtEndDateGen').val() == "")
    {
        MessageCenter('Please enter End date', 'error');
        return false;
    }

    BindPayInData();
}

$('#ddlBranchNameGen').on('change', function ()
{


    MessageCenter('', '');

    if ($('#ddlBranchNameGen').val() == "0")
    {
        MessageCenter('Please select Location', 'error');
        $('#ddlStateNameGen').empty();
        ClearFormGen();
        return false;
    }
    var StateCode = $('#ddlBranchNameGen').val();

    $('#ddlStateNameGen').empty();
    ClearFormGen();
    $('#tblAlllocations > tbody').html('');
    var htmlstr = '';
    ExtendedAjaxCall('PayinSlip/GetCMSBranch?locCode=' + StateCode + '', null, 'GET', function (result)
    {

        if (result !== null && typeof (result) !== 'undefined')
        {
            if (result.length > 0)
            {
                $('#ddlStateNameGen').empty();
                $('#ddlStateNameGen').append("<option value='0' data-row='0'>Select</option>");
                $.each(result, function (i, row)
                {

                    $('#ddlStateNameGen').append("<option value='" + row['Agency_CMS_Branch_Code'] + "' data-row='" + JSON.stringify(row) + "'>" + row['Agency_CMC_Branch_Name'] + "</option>");
                });

            } else
            {
                $('#lblLookUpMessage').text('No Request found').addClass('red-text');
            }
        } else
        {
            $('#lblLookUpMessage').text('something went wrong while binding Request').addClass('red-text');
        }
    }, null, null, false, false, ErrorFunction);


});

function ClearFormGen()
{
    $('#txtEndDateGen').val('');
    $('#txtStartDateGen').val('');
    $('#tblStagingGen > tbody').html('');
}



function BindPayInData()
{
    var BTPlocname = $('#ddlBranchNameGen option:selected').text();
    var BTPlocCode = $('#ddlBranchNameGen').val();

    //if (EXC_CMS_MAPPING_FLAG == 1)
    //{
    //    var CMSlocname = $('#txtEXCCMSbankName').val();
    //    var CMSlocCode = $('#hdnEXCCMSbankCode').val();
    //}
    //else if (EXC_CMS_MAPPING_FLAG == 1)
    //{
    //    var CMSlocname = $('#ddlStateName option:selected').text();
    //    var CMSlocCode = $('#ddlStateName').val();
    //}

    var CMSlocname = $('#ddlStateNameGen option:selected').text();
    var CMSlocCode = $('#ddlStateNameGen').val();

    var BranchCode = $('#ddlStateNameGen').val();

    var BankName = $('#ddlBankNameGen').val();
    var fromdate = $('#txtStartDateGen').val();
    var todate = $('#txtEndDateGen').val();

    $('#tblStagingGen > tbody').html('');
    var htmlstr = '';
    $('#tblStaging').DataTable().destroy();
    ExtendedAjaxCall('PayinSlip/GetpainsliphdrData?CMSBankName=' + BankName + '&MFBranchCode=' + BranchCode + '&CMSLOCCODE=' + CMSlocCode + '&CMSLOCNAME=' + CMSlocname + '&fromdate=' + fromdate + '&todate=' + todate + '&BTP_LocationCode=' + BTPlocCode + '&BTP_LocationDesc=' + BTPlocname + '', null, 'GET', function (result)
    {

        if (result !== null && typeof (result) !== 'undefined')
        {

            if (result.length > 0)
            {
                $.each(result, function (i, row)
                {
                    // htmlstr += '<tr>';
                    htmlstr += '<tr><td class="text-center">';
                    htmlstr += "<input type='radio' name='PAYINSLIP' data-row ='" + JSON.stringify(row) + "'/></td>";
                    htmlstr += '<td style=display:none>' + row["Payinslip_HdrSequence"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["Payinslip_Stg_HdrSequence"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["Payinslip_SourceName"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["PortalSourceCode"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["MCP_Code"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["SCP_Code"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["MCP_Broker_Code"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["SCP_Broker_Code"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["Employee_Code"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["ADO_Indicator"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["CMS_Type"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["CMS_Bank_Name"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["CMS_Branch_Name"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["CMS_Bank_IFSC_Code"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["CMS_Bank_MICR_Code"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["MF_Branch_Code"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["MF_Branch_Name"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["SCP_Location_Code"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["SCP_Location_Name"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["Entry_Date"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["Pickup_Date"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["Payinslip_No"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["Remarks"] + '</td>';
                    htmlstr += '<td style=display:none>' + row["Queue_Remarks"] + '</td>';
                    htmlstr += '<td align="center">' + row["Payinslip_No"] + '</td>';
                    htmlstr += '<td align="center">' + row["PayInSlipGeneratedDate"] + '</td>';
                    htmlstr += '<td align="center">' + row["CreatedByUser"] + '</td>';
                    htmlstr += '<td align="center">' + row["ChequeCount"] + '</td>';

                    htmlstr += '</tr>';

                });
                $('#tblStagingGen > tbody').html(htmlstr);

                $('#divGetDetailsGen').show();

                $('#tblStagingGen').DataTable({
                    destroy: true,
                    initComplete: function ()
                    {
                        $("#preloader").hide();
                    }
                });
                // MainBtnHandler(false, false, true, false, false, true, false);
                //$('#btnCancelGen').bind('click', CancelClickGen);

            } else
            {
                MessageCenter("Data not found", 'error');

            }
        } else
        {

            MessageCenter("Data not found", 'error');
        }

    }, null, null, false, false, ErrorFunction);

}

function getBankGen()
{



    ExtendedAjaxCall('PayinSlip/GetBank', null, 'GET', function (result)
    {
        if (result !== null && typeof (result) !== 'undefined')
        {
            if (result.length > 0)
            {
                $('#ddlBankNameGen').empty();
                $('#ddlBankNameGen').append("<option value='0' data-row='0'>Select</option>");
                $.each(result, function (i, row)
                {

                    $('#ddlBankNameGen').append("<option value='" + row['Cms_Bank_Code'] + "' data-row='" + JSON.stringify(row) + "'>" + row['Cms_Bank_Name'] + "</option>");
                });

            } else
            {
                $('#lblLookUpMessage').text('No Request found').addClass('red-text');
            }
        } else
        {
            $('#lblLookUpMessage').text('something went wrong while binding Request').addClass('red-text');
        }
    }, null, null, false, false, ErrorFunction);
}

var d = new Date();

var month = d.getMonth() + 1;
var day = d.getDate();

//var output = (day < 10 ? '0' : '') + day + '/' +
//    (month < 10 ? '0' : '') + month + '/' +
//    d.getFullYear();
var output = (day < 10 ? '0' : '') + day +
    (month < 10 ? '0' : '') + month +
    d.getFullYear();


function getBranchGen()
{

    ExtendedAjaxCall('PayinSlip/GetBranch', null, 'GET', function (result)
    {
        if (result !== null && typeof (result) !== 'undefined')
        {
            if (result.length > 0)
            {
                $('#ddlBranchNameGen').empty();
                $('#ddlBranchNameGen').append("<option value='0' data-row='0'>Select</option>");
                $.each(result, function (i, row)
                {

                    $('#ddlBranchNameGen').append("<option value='" + row['Agency_Loc_Cd'] + "' data-row='" + JSON.stringify(row) + "'>" + row['Agency_Loc_Desc'] + "</option>");
                });

            } else
            {
                $('#lblLookUpMessage').text('No Request found').addClass('red-text');
            }
        } else
        {
            $('#lblLookUpMessage').text('something went wrong while binding Request').addClass('red-text');
        }
    }, null, null, false, false, ErrorFunction);
}


$('#tblStagingGen #chkAddSelectAll').on('change', function ()
{
    if ($('#tblStagingGen #chkAddSelectAll').prop('checked'))
    {
        $('#tblStagingGen input[type=checkbox]').each(function (key, element)
        {
            $(element).prop('checked', true);
        });
    } else
    {
        $('#tblStagingGen input[type=checkbox]').each(function (key, element)
        {
            $(element).prop('checked', false);
        });
    }
});

$('#btnGenerate').on('click', function ()
{
    try
    {

        var BLocCode = $('#ddlBranchNameGen').val();
        var CMSLocCode = $('#ddlStateNameGen').val();

        var PIS = "PIS";
        MessageCenter('', '');
        var HdrSeq = "";
        var payslipno = "";
        $('#tblStagingGen  > tbody input[type=radio]:checked').each(function (key, element)
        {
            //select row
            var row = $(element).data('row');

            HdrSeq = row["Payinslip_HdrSequence"];
        });

        if (HdrSeq == "")
        {
            MessageCenter("Please select Atleast on record", 'error');
            return false;

        } else
        {
            //$('#tblStaging1 > thead').html('');
            $('#tblStaging1 > tbody').html('');
            var htmlstr = "";
            var htmlClientDtl = "";
            ExtendedAjaxCall('PayinSlip/GetPayinslipDtlData?HdrSeq=' + HdrSeq + '', null, 'GET', function (result)
            {

                if (result !== null && typeof (result) !== 'undefined')
                {
                    if (result.Table.length > 0)
                    {
                        var clientcode = "(" + result.Table1[0].f_Bank_Client_Id + ")";

                      
                        htmlClientDtl += '<tr>';
                        htmlClientDtl += '<td>' + result.Table1[0].f_Bank_Client_Id + '</td>';
                        htmlClientDtl +='<td>' + result.Table1[0].f_Bank_Client_Name + '</td>';
                        htmlClientDtl += '</tr>';
                        htmlClientDtl += '<tr>';
                        htmlClientDtl += '</tr>';
                        $('#tblClientDtl> tbody').html(htmlClientDtl);



                        //htmlstr += '<tr style="border:1px solid #000;">';
                        //htmlstr += '<th>SR NO</th>';
                        //htmlstr += '<th><span id="spClientCode">' + clientcode + '</span>PAY IN SLIP NO</th>';
                        //htmlstr += '<th>Entry Date</th>';
                        //htmlstr += '<th>Pick Up Date</th>';
                        //htmlstr += '<th>Branch</th>';
                        //htmlstr += '<th>Appl No</th>';
                        //htmlstr += '<th>Applicant Name</th>';
                        //htmlstr += '<th>Amount</th>';
                        //htmlstr += '<th>Cheque No</th>';
                        //htmlstr += '<th>Bank</th>';
                        //htmlstr += '<th>PAYIN SLIP BATCH NO</th>';
                        //htmlstr += '</tr>';
                        //$('#tblStaging1> thead').html(htmlstr);


                        htmlstr = '';
                        $.each(result.Table, function (i, row)
                        {
                            payslipno = row["PayslipNo"];
                            htmlstr += '<tr>';

                            htmlstr += '<td>' + row["SRNO"] + '</td>';
                            htmlstr += '<td>' + row["PayslipNo"] + '</td>';
                            htmlstr += '<td>' + row["Entry Date"] + '</td>';
                            htmlstr += '<td>' + row["Pick Up Date"] + '</td>';
                            htmlstr += '<td>' + row["f_MF_Branch_Name"] + '</td>';
                            htmlstr += '<td>' + row["f_Application_Number"] + '</td>';
                            htmlstr += '<td>' + row["f_Applicant_Name"] + '</td>';
                            htmlstr += '<td>' + row["f_Cheque_Amt"] + '</td>';
                            htmlstr += '<td>' + row["f_Cheque_Number"] + '</td>';
                            htmlstr += '<td>' + row["f_Drawn_Bank_Name"] + '</td>';
                            htmlstr += '<td>' + row["f_Payinslip_HdrSequence"] + '</td>';

                            htmlstr += '</tr>';

                        });
                        $('#tblStaging1> tbody').html(htmlstr);

                        $("#spClientCode").text(clientcode);

                        var doc = new jsPDF('l', 'in', 'a3');

                        doc.autoTable({
                            html: '#tblClientDtl',
                            theme: 'plain',
                            styles: {                                                              
                                tableWidth: 'auto',
                                columnStyles: 'auto'
                            },
                        });
                        doc.autoTable({ html: '#tblStaging1', theme: 'plain' });

                        doc.save(PIS + '_' + output + '_' + BLocCode + '_' + CMSLocCode + '_' + '.pdf');
                        // alert('Pdf downloaded please check');
                        MessageCenter("PayInSlip generated successfully for " + payslipno, 'success');



                    } else
                    {
                        MessageCenter("Data not found", 'error');

                    }
                } else
                {
                    $('#lblLookUpMessage').text('something went wrong while binding Request').addClass('red-text');

                }
            }, null, null, false, false, ErrorFunction);

        }



    } catch (e)
    {
        console.error(e);
    }

});


function rdoCMS_select_Gen(btn)
{

    var code = $(btn).val();
    var name = $($(btn).closest('tr').find('td')[1]).text();
    if ($("#ddlStateNameGen option[value='" + code + "']").length != 0)
    {
        // it exists!
        $('#ddlStateNameGen').val(code).change();
    }
    else
    {
        var html = '<option value="' + code + '">' + name + '</option>';
        $('#ddlStateNameGen').append(html).val(code).change();
    }
    $('#ModelCMSBranchCloseGen').click();
    $('#ddlStateGen').val('select').change();
    $('#ddlEXCCMSBranchGen').val('select');
    //$('#modellblErrormsg').text('');
};


